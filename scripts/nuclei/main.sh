#!/bin/bash

shopt -s expand_aliases

data_folder="data"

read -p "what's the filename? → " input

#==========================================
# Create folder if not exist
#==========================================
if [ ! -d $data_folder ]; then
  mkdir $data_folder
fi

while read -u 9 domain; do

  echo "→ Scan started for $domain"

  #==========================================
  # Create folder if not exist
  #==========================================
  if [ -d $data_folder/$domain ]; then
    continue
  else
    mkdir $data_folder/$domain
  fi

  #==========================================
  # Identify the website technology
  #==========================================
  ~/wpt/libs/WhatWeb/whatweb $domain --log-verbose=$data_folder/$domain/tech.txt

  #==========================================
  # Find the subdomains
  #==========================================
  subfinder -d $domain | httpx >>$data_folder/$domain/subdomains.txt

  #==========================================
  # Find the directories
  #==========================================
  python3 ~/wpt/libs/dirsearch/dirsearch.py -u $domain --random-agent -i 200,500 -o $data_folder/$domain/directories.txt

  #==========================================
  # Nuclei templates
  #==========================================
  nuclei --update-templates --silent
  nuclei_templates=(
    "cnvd"
    "cves"
    "default-logins"
    "dns"
    "exposed-panels"
    "exposures"
    "file"
    "fuzzing"
    "headless"
    "helpers"
    "iot"
    "misconfiguration"
    "network"
    "takeovers"
    "technologies"
    "token-spray"
    "vulnerabilities"
    "workflows"
  )
  for template in ${nuclei_templates[@]}; do
    echo "→ Scan for $template started"
    nuclei -l $data_folder/$domain/subdomains.txt -t $template/ -o $data_folder/$domain/$template.txt
  done

  #==========================================
  # Finish the scan
  #==========================================
  echo "→ Scan completed for $domain"

done 9<$input
